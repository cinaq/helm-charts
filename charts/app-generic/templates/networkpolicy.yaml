{{- if .Values.networkPolicy.enabled -}}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "app-generic.fullname" . }}
  labels:
    {{- include "app-generic.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "app-generic.selectorLabels" . | nindent 6 }}
  policyTypes:
  - Ingress
  - Egress
  
  ingress:
  {{- if .Values.networkPolicy.ingress.enabled }}
  # Allow ingress from nginx ingress controller
  - from:
    {{- if .Values.networkPolicy.ingress.namespaceSelector }}
    - namespaceSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.ingress.namespaceSelector | nindent 10 }}
      {{- if .Values.networkPolicy.ingress.podSelector }}
      podSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.ingress.podSelector | nindent 10 }}
      {{- end }}
    {{- else }}
    - namespaceSelector: {}
    {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.service.internalPort }}
  {{- end }}

  egress:
  # Rule 1: DNS resolution (REQUIRED)
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # Rule 2: PostgreSQL database
  {{- if .Values.networkPolicy.egress.postgresql.enabled }}
  - to:
    {{- if .Values.networkPolicy.egress.postgresql.namespaceSelector }}
    - namespaceSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.postgresql.namespaceSelector | nindent 10 }}
    {{- else }}
    - podSelector: {}
    {{- end }}
    {{- if .Values.networkPolicy.egress.postgresql.podSelector }}
      podSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.postgresql.podSelector | nindent 10 }}
    {{- end }}
    ports:
    - protocol: TCP
      port: {{ .Values.networkPolicy.egress.postgresql.port | default 5432 }}
  {{- end }}

  # Rule 3: S3 Gateway (object storage)
  {{- if .Values.networkPolicy.egress.s3Gateway.enabled }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.s3Gateway.namespaceSelector | nindent 10 }}
      podSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.s3Gateway.podSelector | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.networkPolicy.egress.s3Gateway.port | default 9000 }}
  {{- end }}

  # Rule 4: Tempo/OTEL (observability)
  {{- if .Values.networkPolicy.egress.tempo.enabled }}
  - to:
    - namespaceSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.tempo.namespaceSelector | nindent 10 }}
      podSelector:
        matchLabels:
          {{- toYaml .Values.networkPolicy.egress.tempo.podSelector | nindent 10 }}
    ports:
    - protocol: TCP
      port: {{ .Values.networkPolicy.egress.tempo.grpcPort | default 4317 }}
    - protocol: TCP
      port: {{ .Values.networkPolicy.egress.tempo.httpPort | default 4318 }}
  {{- end }}

  # Rule 5: External connectivity (webhooks, APIs, etc.)
  {{- if .Values.networkPolicy.egress.external.enabled }}
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
        {{- if .Values.networkPolicy.egress.external.exceptCIDRs }}
        except:
        {{- toYaml .Values.networkPolicy.egress.external.exceptCIDRs | nindent 8 }}
        {{- end }}
    {{- if .Values.networkPolicy.egress.external.ports }}
    ports:
    {{- toYaml .Values.networkPolicy.egress.external.ports | nindent 4 }}
    {{- else }}
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 443
    {{- end }}
  {{- end }}

  # Rule 6: Custom egress rules
  {{- if .Values.networkPolicy.egress.custom }}
  {{- toYaml .Values.networkPolicy.egress.custom | nindent 2 }}
  {{- end }}
{{- end -}}
